# TTS音频完整性测试指南

本指南介绍如何使用提供的Python脚本测试TTS（文本转语音）系统的音频完整性，特别是验证短文本处理和音频返回是否完整。

## 测试工具概述

我们提供了测试工具：
1. `tts_audio_test.py` - Python版本的WebSocket客户端测试工具

本指南主要介绍Python版本的使用方法，该工具具有更好的跨平台兼容性和易用性。

## 前置条件

在运行测试前，请确保：

1. 已安装Python 3.7或更高版本
2. 已安装websockets库
3. EchoMe后端服务正在运行（默认端口8081）

## 环境设置

### 安装依赖

首先，安装测试所需的Python依赖：

```bash
pip install websockets
```

### 准备后端服务

确保EchoMe后端服务正常运行。如果尚未启动，可以使用以下命令启动：

```bash
# 在项目根目录下
make run
```

## 运行测试

### 基本用法

在项目根目录下，运行以下命令启动测试：

```bash
python tools/tts_audio_test.py
```

这将使用默认配置连接到`ws://localhost:8081/ws/voice-conversation`，并执行所有测试用例。

### 自定义参数

测试脚本支持多个命令行参数来自定义测试行为：

```bash
python tools/tts_audio_test.py --url ws://localhost:8081/ws/voice-conversation --characterId your_character_id --output results.json --debug --timeout 45
```

参数说明：

- `--url` - WebSocket服务器URL（默认：ws://localhost:8081/ws/voice-conversation）
- `--characterId` - 可选的角色ID
- `--output` - 测试结果输出文件（默认：tts_test_results.json）
- `--debug` - 启用调试日志
- `--timeout` - 每个测试用例的超时时间（秒，默认：30）

## 测试用例说明

测试脚本包含以下测试用例，全面覆盖不同场景：

1. **短文本测试(10字符)** - 测试系统对极短文本的处理能力
2. **短文本带标点测试** - 测试带标点符号的短文本处理
3. **中等长度文本测试** - 测试约50个字符的中等长度文本
4. **长文本测试** - 测试包含多个句子的长文本
5. **多标点符号文本测试** - 测试包含多种标点符号的文本

## 测试结果分析

测试完成后，将显示如下输出：

```
测试: 短文本测试(10字符) - ✅ 成功
测试: 短文本带标点测试 - ✅ 成功
测试: 中等长度文本测试 - ✅ 成功
测试: 长文本测试 - ✅ 成功
测试: 多标点符号文本测试 - ✅ 成功

=== 测试总结 ===
总测试用例: 5
成功: 5
失败: 0
成功率: 100.0%
测试结果已保存至: tts_test_results.json
```

### 结果文件格式

测试结果以JSON格式保存到指定的输出文件中，每条结果包含以下字段：

- `test_case` - 测试用例名称
- `success` - 测试是否成功
- `message` - 测试结果消息或错误信息
- `audio_received` - 是否接收到音频数据
- `audio_size` - 接收到的音频数据总大小（字节）
- `binary_messages_received` - 接收到的二进制消息数量
- `response_time` - 响应时间（毫秒）

### 验证TTS音频完整性

要验证TTS音频完整性，可以重点关注以下指标：

1. **短文本处理** - 确认"短文本测试(10字符)"和"短文本带标点测试"是否成功通过
2. **音频接收情况** - 检查每个测试用例的`audio_received`是否为`true`
3. **音频大小** - 确认`audio_size`是否合理（不为0）
4. **响应时间** - 了解系统的响应性能

## 常见问题排查

如果测试失败，可以根据以下情况进行排查：

### 1. 连接失败
- 确保后端服务正在运行
- 检查WebSocket URL是否正确
- 验证网络连接和防火墙设置

### 2. 短文本测试失败
- 错误信息：`未收到任何音频数据`或`收到的音频数据为空`
- 可能原因：TTS服务对短文本处理存在问题，或缓冲区管理逻辑需要优化
- 解决方案：参考之前的修复，确保即使短文本也能正确发送和处理

### 3. 超时错误
- 错误信息：`未收到流结束消息，测试超时`
- 可能原因：服务器处理时间过长，或WebSocket连接中断
- 解决方案：增加超时时间（使用`--timeout`参数），检查服务器日志

### 4. 音频不完整
- 如果音频播放时出现截断或不完整现象
- 可能原因：音频数据在传输过程中丢失，或TTS处理逻辑有问题
- 解决方案：检查服务器端的音频数据发送逻辑，确保完整转发所有音频数据

## 高级测试场景

### 批量测试

可以修改测试脚本中的`test_cases`数组，添加更多自定义测试用例，或调整现有测试文本以覆盖特定场景。

### 与实际音频播放器集成

对于更严格的测试，可以扩展脚本以将接收到的音频数据保存为文件，然后使用音频播放器手动验证或使用音频分析工具自动验证完整性。

## 开发调试建议

在开发和调试过程中：

1. 使用`--debug`参数启用详细日志，查看完整的交互过程
2. 结合后端服务日志一起分析问题
3. 对于复杂问题，可以修改测试脚本添加更多自定义测试场景

## 注意事项

1. 确保在进行测试时，服务器资源充足，避免因资源限制导致测试不准确
2. 对于大规模测试，建议增加测试间隔时间，避免服务器过载
3. 测试结果可能会受到网络条件的影响，建议在稳定的网络环境下进行测试

通过定期运行这些测试，可以确保TTS系统的音频完整性，特别是针对短文本的处理能力，从而提供更好的用户体验。